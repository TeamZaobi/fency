# PRD: 凿壁知识库与图谱

## 1. 产品概述
### 1.1 文档标题和版本
   - PRD: 凿壁知识库与图谱
   - 版本: 2.0

### 1.2 产品摘要
   - 本项目旨在重构现有的 "凿壁" 网站 (`index.html`)，将其从一个手动维护的链接聚合页面，转变为一个动态展示内容卡片和交互式知识图谱的知识库前端。核心目标是自动化内容的索引和关联展示，提升用户发现和探索知识的体验。
   - 新的 `index.html` 将通过客户端 JavaScript 读取一个自动维护的 `metadata.json` 文件。该文件包含了所有由 LLM 生成的独立 HTML 内容页面的元数据（标题、摘要、分类、发布日期、关键词等）。页面加载后，将动态渲染内容卡片列表，并使用专门的库绘制一个知识图谱，通过共享关键词将不同内容页面连接起来。
   - 内容发布流程将进行调整：当使用 LLM 生成新的独立 HTML 页面时，相关的 `.cursor` 规则 (`web-dev.mdc`) 将指导 LLM 提取页面元数据（包括关键词），并自动、健壮地更新 `html/metadata.json` 文件，而不再需要手动编辑 `index.html`。

## 2. 目标
### 2.1 业务目标
   - 自动化 `index.html` 的内容更新，减少手动维护成本。
   - 通过知识图谱可视化内容间的关联，提升知识库的探索价值。
   - 继续作为展示 LLM 在网页设计和内容生成方面创意潜力的平台。
   - 继续作为发布和归档个人学习笔记和思考（以独特网页形式）的空间。

### 2.2 用户目标
   - **内容消费者 (访客):**
     - 访问 `index.html` 时，能够快速加载并看到按时间排序的内容卡片列表。
     - 能够通过交互式知识图谱直观地发现不同内容页面之间的主题关联。
     - 能够顺畅地在内容卡片、图谱节点和实际内容页面之间导航。
     - 能够切换页面的深色/浅色主题模式。
   - **内容创建者 (项目维护者):**
     - 专注于使用 LLM 生成高质量、符合规则的独立 HTML 页面。
     - 无需手动编辑 `index.html`，新发布的内容能够自动出现在主页和知识图谱中。
     - 能够信任 `metadata.json` 文件更新的自动化和健壮性。

### 2.3 非目标
   - 实现复杂的全文搜索功能（超出卡片和图谱范围）。
   - 提供用户评论、评分或社交分享功能。
   - 实现用户账户系统或个性化推荐。
   - 严格保证所有 LLM 生成页面之间的视觉风格一致性（维持单页创意优先）。
   - 支持除 `metadata.json` 之外的其他数据源。

## 3. 用户画像
### 3.1 关键用户类型
   - 内容消费者 (访客)
   - 内容创建者 (项目维护者)

### 3.2 基本画像细节
   - **访客**: 对 AI、医疗信息化、科研方法或特定知识报告感兴趣的个人，希望浏览内容并发现知识间的联系。
   - **项目维护者 (季晓康)**: 项目的拥有者和主要内容贡献者，负责使用 LLM 生成内容页面，并维护项目的整体结构和规则。

### 3.3 基于角色的访问
      - **访客**: 可以公开访问 `index.html` 及其链接的所有内容页面 (`html/pages/**/*.html`)。可以与知识图谱交互，切换主题模式。无需登录或注册。
      - **项目维护者**: 拥有对代码库的完全访问权限，负责触发 LLM 内容生成流程，管理 Git 仓库，并可能执行一次性的数据处理任务（如初始元数据生成）。

## 4. 功能需求
   - **元数据加载** (优先级: 高)
     - `index.html` 在客户端加载时，必须异步获取并解析 `html/metadata.json` 文件。
     - 需处理 `metadata.json` 加载失败或格式错误的情况，并向用户提供适当的反馈（例如，显示错误消息）。
   - **自动化内容迁移与修正** (优先级: 高)
     - Cursor/AI 将自动识别并移动旧内容文件到 `html/pages/` 下的分类目录。
     - Cursor/AI 将自动尝试分析 HTML 文件，补充或修正 `<meta>` 标签，并添加返回链接和作者信息。
     - Cursor/AI 将自动进行自我评估和记录分析结果，无需人工审查。
   - **动态内容卡片渲染** (优先级: 高)
     - 根据加载的元数据，**完全动态地**生成内容卡片列表，并插入到 `index.html` 预定义的分类容器中。
     - 每个卡片应显示页面的标题、摘要、发布日期、分类。
     - 卡片需包含指向对应内容页面的链接 (`path`)。
     - 卡片列表默认按发布日期 (`publishDate`) 降序排列。
   - **交互式知识图谱渲染** (优先级: 高)
     - 使用选定的 JavaScript 图谱库（如 Cytoscape.js）渲染知识图谱。
     - 图谱的节点代表 `metadata.json` 中的每个页面。
     - 图谱的边代表共享相同关键词（忽略大小写等基础规范化）的页面之间的连接。
     - 图谱必须支持缩放和平移操作。
     - 点击图谱节点应能清晰地标识该节点（例如高亮）并提供导航到对应页面的方式。
     - (优先级: 中) 点击图谱节点可显示该节点的简要信息（如标题、摘要）。
   - **页面导航** (优先级: 高)
     - 用户可以通过点击内容卡片或图谱节点导航到对应的独立 HTML 内容页面。
     - 每个独立 HTML 内容页面必须包含返回 `index.html` 的链接（此要求由 `web-dev.mdc` 保证，由自动化流程尝试实现和检查）。
   - **深色/浅色主题切换** (优先级: 高)
     - `index.html` 必须提供用户手动切换深色和浅色模式的功能。
     - 默认主题应尝试跟随系统设置。
     - 主题切换应影响页面背景、文本颜色、卡片样式以及知识图谱的视觉呈现（如果库支持）。
   - **自动化元数据更新** (优先级: 高) (由 LLM 及 `.cursor` 规则或独立脚本自动实现)
     - 当通过 LLM + `.cursor/rules/web-dev.mdc` 流程生成新页面时，或通过其他方式添加/修改页面后，**必须自动**提取或更新页面的元数据（包括关键词和文件最后修改时间）。
     - 必须自动读取现有的 `html/metadata.json`。
     - 必须将新页面的元数据（使用 `path` 作为 `id`）添加或更新到 `metadata.json` 的 `pages` 数组中。
     - 更新后的 `metadata.json` 必须通过健壮的方式（如原子写入）写回文件系统，以防止数据损坏。
     - **新增:** 顶层的 `lastUpdated` 时间戳也需要自动更新。
   - **响应式设计** (优先级: 高)
     - `index.html` 及其渲染的内容（卡片、图谱）必须在不同尺寸的设备（桌面、平板、手机）上都能良好显示和交互（由自动化测试进行基础验证）。
   - **自动化元数据初始化脚本** (优先级: 高)
     - 需要一个一次性的 Node.js 脚本，用于在初始内容迁移后，**自动**扫描 `html/pages` 目录并生成初始的 `html/metadata.json` 文件。
     - 脚本需要能从 HTML 文件中提取所有必需的元数据字段，并处理潜在的文件读取或解析错误。

## 5. 用户体验
### 5.1. 入口点和首次用户流程
   - 用户通过直接访问 `index.html` 的 URL 进入。
   - 首次访问时，页面应快速加载基础结构，然后异步加载 `metadata.json`。
   - 在数据加载期间，可以显示一个加载指示器。
   - 数据加载完成后，卡片列表和知识图谱应平滑地渲染出来。

### 5.2. 核心体验
   - **浏览内容卡片**: 访客滚动浏览按时间排序的内容卡片，快速了解近期发布或更新的内容。
     - 卡片设计简洁清晰，信息密度适中，易于阅读和点击。
   - **探索知识图谱**: 访客与知识图谱交互，通过缩放查看整体结构，通过拖动浏览不同区域，通过点击节点发现关联内容。
     - 图谱布局算法应尽可能减少节点重叠，连接关系清晰可见。交互响应流畅。
   - **主题切换**: 访客根据个人偏好或环境光线切换深色/浅色模式。
     - 切换过程平滑，所有相关元素的颜色和样式正确更新。

### 5.3. 高级功能和边缘情况
   - **大量内容处理**: 当页面数量非常多时，考虑对卡片列表进行分页或虚拟滚动，对知识图谱进行性能优化（未来迭代）。
   - **无关联节点**: 图谱中可能存在没有关键词与其他页面关联的节点，应正常显示。
   - **`metadata.json` 加载失败**: 页面应优雅地处理此错误，显示提示信息，而不是白屏或崩溃。
   - **关键词质量**: LLM 提取的关键词可能不完美，图谱连接可能无法完全反映所有逻辑关联，用户应理解图谱是辅助探索工具。

### 5.4. UI/UX 亮点
   - **视觉吸引力**: 知识图谱的可视化呈现应具有一定的美感和现代感。
   - **交互流畅性**: 图谱的缩放、平移、点击等交互应自然且响应迅速。
   - **信息关联**: 通过图谱直观展示内容关联是核心亮点。
   - **主题适应**: 完善的深色/浅色模式支持提升阅读舒适度。

## 6. 叙述
访客小张对 AI 技术在医疗领域的应用很感兴趣，偶然发现了"凿壁知识库与图谱"网站。他打开主页，首先看到的是按时间顺序排列的最新文章卡片，简洁地展示了标题和摘要。更吸引他的是页面下方的交互式知识图谱，节点代表不同的文章，连线表示它们共享相似的关键词。小张通过缩放和平移浏览图谱，发现几篇关于"AI 辅助诊断"的文章相互连接，点击其中一个节点，图谱高亮了该节点并显示了摘要，小张轻松地跳转阅读了这篇文章，并通过图谱发现了几篇相关的拓展阅读内容，极大地丰富了他对该主题的理解。

## 7. 成功指标
### 7.1. 以用户为中心的指标
   - 页面平均停留时长（`index.html`）。
   - 知识图谱交互率（进行缩放、平移、点击操作的用户比例）。
   - 从 `index.html` 到内容页面的点击转化率（通过卡片或图谱）。
   - 主题切换功能使用率。

### 7.2. 业务指标
   - 新内容页面发布的频率（衡量内容创建活动）。
   - `metadata.json` 自动更新成功率。

### 7.3. 技术指标
   - `index.html` 页面加载时间 (LCP, FCP)。
   - `metadata.json` 文件大小和解析时间。
   - 知识图谱渲染时间和交互帧率。
   - JavaScript 运行时错误率。

## 8. 技术考虑因素
### 8.1. 集成点
   - **LLM 内容生成流程**: 需要与 `.cursor/rules/web-dev.mdc` 紧密集成，确保规则能正确指导 LLM 更新 `metadata.json`。
   - **JavaScript 图谱库**: 需要选择、引入并配置合适的库 (如 Cytoscape.js)。
   - **版本控制 (Git)**: 所有代码（HTML, CSS, TS, `metadata.json`）和规则文件都需要纳入版本控制。
   - **静态文件托管**: 需要部署到支持静态文件服务的平台（如 GitHub Pages, Vercel, Netlify）。

### 8.2. 数据存储和隐私
   - 主要数据存储在 `html/metadata.json` 文件中，随代码库一起版本控制。
   - 不涉及用户个人身份信息 (PII) 的存储或处理。
   - 内容页面本身可能包含作者信息（按规则定义），属于公开信息。

### 8.3. 可扩展性和性能
   - **`metadata.json` 大小**: 随着页面增多，文件会增大，可能影响加载和解析时间。需要监控其大小。
   - **图谱性能**: 节点和边的数量增加会对渲染和交互性能产生压力。选择性能良好的库并进行适当优化至关重要。考虑未来可能需要更高级的渲染技术（如 WebGL 渲染器，如 Sigma.js）。
   - **客户端计算**: 所有渲染和交互逻辑都在客户端执行，用户设备的性能会影响体验。

### 8.4. 潜在挑战
   - **关键词提取质量**: LLM 提取的关键词可能不一致或不准确，影响图谱连接的有效性。
   - **`metadata.json` 维护**: 确保 LLM 遵循规则、健壮地更新 JSON 文件是关键，需要仔细设计 `.mdc` 规则和错误处理。
   - **图谱库选型与定制**: 选择合适的库并根据需求进行样式和交互定制可能需要一定的学习和开发成本。
   - **前端性能优化**: 在内容量大时，保持 `index.html` 的加载和交互性能需要持续关注和优化。

## 9. 里程碑和排序
### 9.1. 项目估算
   - 中等: 3-5 周 (假设已有前端开发基础和 LLM 使用经验)

### 9.2. 团队规模和构成
   - 小型团队：总共 1-2 人
     - 项目维护者/全栈开发者 (负责前端开发、LLM 交互、规则维护)

### 9.3. 建议阶段
   - **阶段 0**: 内容迁移与元数据初始化 (0.5 - 1 周)
     - 关键可交付成果：将现有内容迁移到 `html/pages/`；编写并执行一次性脚本生成初始 `html/metadata.json`。
   - **阶段 1**: 基础结构与卡片渲染 (1 - 1.5 周)
     - 关键可交付成果：创建 `html/` 目录结构和基础 `index.html`；设置 TS 环境；实现加载 `metadata.json` 并按日期降序渲染内容卡片的功能。
   - **阶段 2**: 知识图谱集成 (1 - 1.5 周)
     - 关键可交付成果：引入图谱库；实现基于 `metadata.json` 构建图谱数据并渲染；实现基本的图谱交互（缩放、平移、点击节点跳转）。
   - **阶段 3**: 样式、主题与交互完善 (0.5 - 1 周)
     - 关键可交付成果：应用 CSS 样式；实现深色/浅色主题切换；完善图谱节点点击信息展示；进行响应式设计测试和调整。
   - **阶段 4**: 更新内容生成规则 (并行或最后)
     - 关键可交付成果：修改 `.cursor/rules/web-dev.mdc` 文件，移除手动更新 `index.html` 的要求，添加自动化、健壮地更新 `metadata.json` (含关键词提取) 的规则。

## 10. 用户故事
### 10.1. 访问索引页并查看内容
   - **ID**: US-201
   - **描述**: 作为访客，我想要访问 `index.html` 页面，以便看到**完全动态加载和渲染**的内容卡片列表和知识图谱的初始视图。
   - **验收标准**:
     - 浏览器地址栏输入 `index.html` 的 URL 后，页面成功加载。
     - 页面异步加载 `html/metadata.json` 文件。
     - 数据加载完成后，内容卡片区域 (`#card-container`) 显示根据元数据生成的卡片列表。
     - 卡片按发布日期降序排列。
     - 每个卡片显示标题、摘要、发布日期、分类，并包含指向对应页面的链接。
     - 知识图谱区域 (`#knowledge-graph`) 显示根据元数据生成的图谱（节点和基于关键词的边）。
     - 如果 `metadata.json` 加载失败，页面显示清晰的错误提示信息。

### 10.2. 与知识图谱交互以探索内容
   - **ID**: US-202
   - **描述**: 作为访客，我想要与知识图谱进行交互（缩放、平移、点击），以便发现内容之间的关联并导航到感兴趣的页面。
   - **验收标准**:
     - 可以使用鼠标滚轮或触摸手势缩放知识图谱。
     - 可以通过拖动鼠标或触摸手势平移知识图谱视图。
     - 点击图谱中的某个节点时，该节点被视觉上高亮（例如改变颜色或大小）。
     - (中优先级) 点击节点时，可以显示该节点的标题和摘要信息（例如在侧边栏或浮动框中）。
     - 点击高亮的节点或其关联信息区域，可以导航到该节点对应的 HTML 内容页面。

### 10.3. 切换页面主题模式
   - **ID**: US-203
   - **描述**: 作为访客，我想要在深色和浅色模式之间切换 `index.html` 的主题，以便在不同的光线条件下获得更舒适的阅读体验。
   - **验收标准**:
     - 页面上提供一个清晰可见的主题切换控件（例如按钮或开关）。
     - 点击该控件可以在深色和浅色模式之间切换。
     - 切换时，页面的背景、文本颜色、卡片样式以及知识图谱的外观（背景、节点/边颜色）会相应更新。
     - 页面首次加载时，会尝试匹配操作系统的颜色模式偏好。
     - 用户选择的主题模式在单次会话中应保持不变（刷新页面后可恢复默认或系统设置）。

### 10.4. (维护者) 触发新内容生成与自动索引
   - **ID**: US-204
   - **描述**: 作为项目维护者，我想要通过与 LLM 的交互（遵循更新后的 `.cursor/rules/web-dev.mdc` 规则）来生成新的独立 HTML 内容页面，并让系统**完全自动地**更新知识库索引 (`metadata.json`)，**无需手动编辑任何索引文件**。
   - **验收标准**:
     - 当我提供 Markdown 内容并触发 LLM 生成页面时，LLM 遵循 `.mdc` 规则生成符合要求的 HTML 文件。
     - LLM 过程中或完成后，自动触发元数据更新脚本/流程。
     - 元数据更新脚本/流程成功提取新页面的元数据（标题、描述、日期、分类、路径、关键词、最后修改时间）。
     - 元数据更新脚本/流程成功读取当前的 `html/metadata.json` 文件。
     - 元数据更新脚本/流程将新页面的元数据（使用 `path` 作为 `id`）正确添加到内存中的数据结构里，并更新顶层 `lastUpdated` 时间戳。
     - 元数据更新脚本/流程通过健壮的方式（如原子写入）将新的 JSON 数据写回 `html/metadata.json` 文件。
     - 如果更新 `metadata.json` 的任何步骤失败，原文件保持不变，并能获得错误提示。
     - 我无需手动编辑 `index.html` 或 `metadata.json`。

### 10.5. (系统) 处理元数据更新失败
   - **ID**: US-205
   - **描述**: 作为元数据自动更新系统，当更新 `metadata.json` 过程中发生错误时，我需要保证原始 `metadata.json` 文件不被破坏，并能通过日志或其他方式向维护者指示发生了错误。
   - **验收标准**:
     - 在尝试更新 `metadata.json` 之前，系统（规则执行流程）能成功读取或至少知道原始文件的状态。
     - 如果在更新流程中（读取、修改、序列化、写入临时文件、验证、重命名）的任何环节发生错误，最终的 `html/metadata.json` 文件内容应与更新操作开始前一致。
     - 更新失败时，应有明确的日志或反馈给维护者，指出更新失败及其可能原因。

### 10.6. (系统) 自动执行初始元数据生成
   - **ID**: US-206
   - **描述**: 作为自动化系统的一部分，在内容迁移完成后，我需要**自动执行**一个一次性的 Node.js 脚本，扫描所有位于 `html/pages/` 的 HTML 文件，并自动生成初始的 `html/metadata.json` 文件。
   - **验收标准**:
     - 存在一个明确的 Node.js 脚本可以自动执行此操作。
     - 自动化流程在内容迁移后自动触发该脚本的执行。
     - 执行该脚本后，会在 `html/` 目录下生成一个 `metadata.json` 文件。
     - 生成的 `metadata.json` 文件包含一个 `pages` 数组，数组中的每个对象对应一个 `html/pages/` 下的 HTML 文件。
     - 每个对象包含从对应 HTML 文件中提取或获取的 `id` (路径), `title`, `description`, `path`, `publishDate`, `category`, `keywords`, 和 `lastModifiedDate`。
     - 生成的 JSON 文件格式有效。
     - 脚本能够处理遍历或文件读取/解析过程中可能出现的错误，并通过日志记录错误。
