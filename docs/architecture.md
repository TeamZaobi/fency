# 架构设计文档: 凿壁 - 知识库与图谱系统

## 1. 引言
本文档基于 `docs/prd.md` 和项目采用 **Cursor 环境下的 "vibe coding" 开发维护模式**，遵循 `.cursor/rules/web-dev.mdc` 中的 LLM 生成指南，为"凿壁"项目设计系统架构。本架构的核心是支持由大语言模型 (LLM) 高效生成独立的、富有创意的 HTML 页面，并通过**维护者引导、规则约束、提示词驱动且包含验证步骤的 Cursor/LLM 交互**，实现元数据管理、动态索引页与知识图谱的组织和可视化。**架构设计的关键在于平衡开发效率与系统可靠性，通过强规则和流程内置校验来管理潜在错误。**

## 2. 架构目标
*   核心目标: 最大化单页创意与独特性
*   **自动化索引 (通过引导式、带验证的交互):** 通过维护者引导 Cursor/LLM，**依据严格的规则和提示词**提取元数据，**并在流程中加入验证步骤**，构建动态索引页和知识图谱，减少手动编辑索引的成本和错误。
*   流程简明性 (在 Cursor 环境内)
*   知识关联
*   明确的权衡
    *   保持单页独立性
    *   中等程度的一致性
    *   **质量保证**: 接受 LLM 可能出错，依赖规则、验证步骤和维护者监督来保证质量。

## 3. 架构模式: 独立 HTML 页面 + 元数据驱动的动态索引 (强规则、带验证的 Cursor/LLM 辅助管理)
*   描述: 每个内容页 (`html/pages/*/`) 是一个完全独立的 HTML 文件，由 LLM 高效生成。文件需严格遵守规则中定义的元数据标签。`html/index.html` 通过读取 `html/metadata.json` 动态生成内容。`metadata.json` 的更新通过维护者在 Cursor 中调用 LLM 完成，**需严格遵循 `.cursor/rules/web-dev.mdc` 中的标准提示词 (P.1, P.2)，且流程中包含 LLM 执行结果的验证环节。**
*   选择理由: 平衡 LLM 的高效率与项目可靠性需求。通过**将约束和验证嵌入到提示词和工作流中**，适应 "vibe coding" 模式。
*   优势: 保持较高开发效率的同时，通过规则和验证步骤降低维护错误风险。

## 4. 系统架构图 (增加验证环节)

```mermaid
graph TD
    subgraph "内容生成"
        A[维护者 + LLM/Cursor] -- **规则/Prompt 指导** --> B(生成独立 HTML 页面<br>含 Meta/内容/样式/脚本);
        B --> B_Val{**LLM/人工检查页面<br>是否符合核心规则**};
    end

    subgraph "元数据管理 (Cursor/LLM 辅助 + 验证)"
        B_Val -- 符合 --> C{维护者确认保存};
        C -- 保存 --> D[html/pages/category/*.html];
        D -- **Prompt 指导 (含验证指令)** --> E_F[**提取元数据 (含关键词)<br>原子更新 metadata.json<br>+ LLM 执行结果校验**];
        E_F -- 验证通过 --> Meta[html/metadata.json];
    end

    subgraph "动态索引"
        G[html/index.html] -- 加载 --> Meta;
        Meta -- 数据 --> H[渲染内容卡片<br>按分类与日期];
        Meta -- 数据 --> I[构建知识图谱<br>基于共享关键词];
    end

    subgraph "用户交互"
        J[用户浏览器] -- 访问 --> G;
        J -- 访问 --> D;
        H --> K[卡片浏览与筛选];
        I --> L[图谱交互与导航];
        K --> M[内容页浏览];
        L --> M;
    end

    style B fill:#f9f,stroke:#333,stroke-width:2px
    style Meta fill:#ccf,stroke:#333,stroke-width:2px
    style H fill:#cfc,stroke:#333,stroke-width:2px
    style I fill:#cfc,stroke:#333,stroke-width:2px
    style B_Val fill:#fec,stroke:#f00,stroke-dasharray: 5 5
    style E_F fill:#fec,stroke:#f00,stroke-dasharray: 5 5
```

**说明 (更新):**
1.  维护者指导 LLM/Cursor 生成 HTML 文件，**严格依据规则和提示词**。
2.  **增加验证步骤**: 生成后，通过 LLM 或人工快速检查页面是否包含必要的元标签和结构，符合核心规则。
3.  维护者确认后保存文件。
4.  维护者通过 Cursor 调用 LLM，**使用包含验证指令的提示词** (如 P.2 中包含 `jq empty metadata.json.tmp` 的验证)，提取元数据并原子更新 `metadata.json`。**LLM 需报告操作结果，包括验证是否成功。**
5.  `html/index.html` 动态加载 `metadata.json` ...
6.  初始元数据生成也需包含验证步骤。

## 5. 核心组件/文件职责 (强调规则和验证)
*   `html/index.html`: ...
*   `html/pages/`: ...
*   `html/metadata.json`: ...
*   `html/js/`: ...
    *   `html/js/main.ts`: ... **必须实现健壮的错误处理，能应对 `metadata.json` 加载失败或格式错误的情况，向用户提供清晰反馈。**
    *   `html/js/types.ts`: ...
*   `html/css/`: ...
*   `.cursor/rules/web-dev.mdc`: **项目的核心约束**。包含详细的页面生成规则、LLM 协作规则，以及**经过测试和验证的标准提示词模板 (如 P.1-P.5)，这些提示词应包含必要的约束和自我校验指令。**

## 6. 数据管理 (强调验证)
*   元数据集中化: ...
*   元数据结构: ...
*   元数据提取与更新 (Cursor/LLM 驱动 + **验证**): ... **维护者需根据 LLM 的执行报告（包括内置验证结果）确认操作成功。**
*   原子更新: LLM 被明确指示采用原子写入策略，**并在提示词中包含验证步骤 (如检查临时文件 JSON 格式)**。

## 6A. 元数据处理详细流程

根据实际项目实践，元数据处理流程已经从概念性方案发展为具体实现。本节详细描述元数据处理的工作流程：

### 6A.1 元数据提取与验证流程

1. **内容生成阶段**：
   * 维护者指导LLM创建HTML页面，确保内容符合项目标准
   * HTML页面应包含基本的`<meta>`标签结构，包括标题、分类、描述等

2. **元数据检查阶段**：
   * 维护者使用Cursor环境手动或通过提示词引导LLM检查HTML文件
   * 检查要点包括：
     - 必需的`<meta>`标签是否存在（category、description、publish-date、keywords）
     - 页面是否包含可见的分类和发布日期信息
     - 是否包含返回首页的链接
     - 是否包含作者信息和版权声明
   * 如发现问题，LLM会提供修复建议

3. **元数据补充阶段**：
   * 对于缺失的元数据，维护者指导LLM执行以下操作：
     - 分析页面内容，提取关键信息
     - 生成适当的元数据值（分类、描述、关键词等）
     - 将生成的元数据添加到HTML文件的`<head>`部分
     - 在页面中添加可见的元数据信息、返回链接和作者信息
   * 修改后的HTML文件保存并进行验证

4. **元数据一致性验证**：
   * 维护者检查修改后的页面是否符合项目标准
   * 验证`<meta>`标签与页面内容的一致性
   * 确保可见元数据与`<meta>`标签内容一致

### 6A.2 元数据处理的经验总结

基于项目实践，我们积累了以下元数据处理经验：

1. **页面特性分析技巧**：
   * 首先查看标题和内容前几段，快速确定页面主题和类别
   * 查找页面中的关键词和概念，作为生成元数据的基础
   * 留意页面风格和呈现方式，确保新元素保持风格一致性

2. **元数据标签选择指南**：
   * 分类标签选择时，区分"科研辅助"和"知识报告"类别
   * 描述应简洁清晰，100-200字符，突出核心内容
   * 关键词选择5-10个相关词组，按重要性排序
   * 发布日期可参考文件创建时间或相近内容发布时间

3. **页面元素添加最佳实践**：
   * 可见元数据信息添加在页面开头区域，通常在标题下方
   * 返回首页链接整合至导航栏中
   * 作者和版权信息统一放置在页面底部
   * 遵循页面原有样式风格

### 6A.3 索引页更新流程

1. **索引页信息提取**：
   * 从已处理的HTML文件中提取：
     - 标题（`<title>`标签）
     - 描述（`<meta name="description">`）
     - 发布日期（`<meta name="publish-date">`）
     - 分类（`<meta name="category">`）
     - 关键词（`<meta name="keywords">`）

2. **索引页内容更新**：
   * 根据文件分类，在`index.html`中找到对应分类区域
   * 添加新文章卡片，包含标题、描述、日期、分类和链接
   * 保持卡片按日期降序排列

3. **知识图谱关联**：
   * 分析关键词，建立文章间的关联关系
   * 更新知识图谱可视化

### 6A.4 未来自动化方向

虽然当前采用半自动化的元数据处理流程，但未来可考虑开发自动化工具：

1. **自动检查工具**：
   * 扫描HTML文件，检查元数据完整性
   * 生成报告，标识需要修复的问题

2. **元数据生成辅助**：
   * 集成LLM API，分析页面内容
   * 自动生成高质量的描述和关键词
   * 保留人工审核环节，确保质量

3. **索引页自动更新**：
   * 开发工具自动从HTML文件提取元数据
   * 基于元数据更新索引页
   * 实现原子更新机制，确保数据一致性

目前的半自动流程在平衡效率和质量方面运行良好，为未来可能的自动化奠定了基础，同时提供了宝贵的经验数据。

## 7. 技术栈 (无变化)
*   ...

## 8. 部署策略 (增加验证)
*   方式: ...
*   构建步骤:
    1. 编译 TypeScript (`tsc -p html/` 或类似)
    2. **(强制) 验证 `metadata.json` 格式有效性 (可通过简单脚本或手动检查)。**
    3. 拷贝相关静态文件到目标服务器。
*   持续部署: ...

## 9. 风险与缓解 (聚焦于流程和验证)
*   **核心风险:** **LLM 操作失败或结果不符合预期 (即使有提示词约束)**，在 "vibe coding" 模式下容易被忽略。
    *   **缓解:**
        *   **强化的规则和提示词**: 持续优化 `.cursor/rules/web-dev.mdc` 中的规则和提示词，使其尽可能明确、无歧义，并包含自我校验逻辑。
        *   **流程内置验证**: **将验证步骤作为强制环节嵌入到关键工作流的提示词中** (如生成页面后的规则检查、`metadata.json` 更新后的格式验证)。LLM 需要明确报告验证结果。
        *   **维护者监督与抽查**: 即使有 LLM 验证，维护者仍需对关键操作结果（如 `metadata.json` 的 diff）进行快速确认或定期抽查。
        *   **简化复杂操作**: 如果某类 LLM 操作（如复杂的 JSON 修改）被证明错误率很高，考虑将其拆分为更简单、更易验证的步骤，或引入更多人工确认环节。
        *   **定期测试提示词**: 如 `plan.md` 所述，定期使用样本数据测试核心提示词的有效性和稳定性。
*   **风险:** **元数据文件损坏**。
    *   **缓解:** 强制执行包含验证的原子更新提示词；维护者确认 LLM 报告的操作成功；定期备份 `metadata.json`；`index.html` 实现健壮的错误处理和用户反馈。
*   **风险:** **性能问题 (客户端)**。
    *   **缓解:** ... (同前，增加监控和按需优化)
*   **风险:** **关键词提取质量不一致**。
    *   **缓解:** ... (同前)
*   **风险:** **安全风险**。
    *   **缓解:** ... (同前，CSP/SRI 推荐，依赖维护者检查)

## 10. 可扩展性与未来 (无变化)
*   ...
