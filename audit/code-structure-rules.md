# 凿壁项目代码结构规则

本文档定义了基于代码结构分析发现的规则和最佳实践，目的是提升代码质量、可维护性和开发效率。

## 1. 文件组织规则

### 1.1 模块化结构

- **规则**: 每个模块应有清晰的边界和单一职责
- **标准**: 单个 TypeScript/JavaScript 文件不应超过 500 行
- **实践**: 
  - 将大型文件拆分为功能独立的小模块
  - 每个模块应具有明确的导出接口
  - 避免循环依赖

### 1.2 目录结构

- **规则**: 使用一致的目录组织方式，反映代码的逻辑结构
- **标准**: 采用特性优先的目录结构，而非技术层次结构
- **实践**:
  ```
  src/
    features/              # 按功能组织的主要特性
      feature-name/        # 单个特性目录
        components/        # 特性相关组件
        services/          # 特性相关服务
        utils/             # 特性特定工具
    shared/                # 共享资源
      components/          # 通用组件
      services/            # 通用服务
      utils/               # 通用工具函数
    assets/                # 静态资产
    types/                 # 类型定义
  ```

### 1.3 命名约定

- **规则**: 使用一致的命名规则
- **标准**:
  - 文件名: 使用连字符命名法 (kebab-case)
  - 类名: 使用帕斯卡命名法 (PascalCase)
  - 变量/函数: 使用小驼峰命名法 (camelCase)
  - 常量: 使用大写下划线命名法 (UPPER_SNAKE_CASE)
- **实践**: 名称应反映内容用途，避免使用非描述性名称

## 2. 代码质量规则

### 2.1 代码重复控制

- **规则**: 消除代码重复，推行"Don't Repeat Yourself"(DRY)原则
- **标准**: 功能相似度超过 70% 的代码应合并重构
- **实践**:
  - 创建共享工具函数库集中管理通用功能
  - 使用继承或组合模式减少重复逻辑
  - 定期运行代码重复检测工具

### 2.2 错误处理标准化

- **规则**: 统一错误处理方式
- **标准**: 所有错误处理必须遵循项目错误处理框架
- **实践**:
  - 创建集中式错误处理服务
  - 使用统一的错误类型和结构
  - 确保所有错误都被记录并适当处理
  - 避免静默失败或错误吞噬

### 2.3 复杂度控制

- **规则**: 控制函数和类的复杂度
- **标准**: 
  - 圈复杂度不超过 10
  - 函数行数不超过 50 行
  - 类方法数量不超过 20 个
- **实践**:
  - 将复杂函数拆分为多个小函数
  - 使用策略模式或责任链模式处理复杂条件逻辑
  - 定期进行复杂度分析和重构

## 3. 依赖管理规则

### 3.1 依赖图控制

- **规则**: 维护清晰、层次化的依赖关系
- **标准**: 依赖链深度不应超过 5 层
- **实践**:
  - 设计清晰的层次架构
  - 引入中间抽象层减少直接依赖
  - 定期分析并优化依赖图

### 3.2 核心节点管理

- **规则**: 谨慎管理高中心度节点（被大量其他模块依赖的节点）
- **标准**: 核心节点变更必须经过严格评审和完整测试
- **实践**:
  - 为核心节点提供稳定 API
  - 避免频繁变更核心节点
  - 为核心节点维护高测试覆盖率（>90%）

### 3.3 第三方依赖

- **规则**: 控制第三方库的使用和引入
- **标准**: 
  - 第三方库数量控制在合理范围内
  - 必须有使用理由和评估记录
- **实践**:
  - 使用依赖包装器隔离第三方代码
  - 避免直接暴露第三方 API
  - 定期审查并更新依赖版本

## 4. 前端特定规则

### 4.1 HTML 结构与元数据

- **规则**: 保持一致的 HTML 结构和完整的元数据
- **标准**: 所有 HTML 页面必须包含完整的元数据标签
- **实践**:
  - 使用模板确保元数据一致性
  - 包含必要的 SEO 元数据（标题、描述、关键词）
  - 遵循无障碍规范 (WCAG)

### 4.2 内部链接策略

- **规则**: 优化内部链接结构
- **标准**: 每个内容页面应至少包含 5 个相关内部链接
- **实践**:
  - 实现相关内容推荐系统
  - 创建内容导航地图
  - 定期分析并优化内部链接结构

### 4.3 UI 组件化

- **规则**: 采用组件化设计
- **标准**: UI 元素应封装为可重用组件
- **实践**:
  - 创建组件库
  - 实现组件文档和演示
  - 遵循设计系统规范

## 5. 数据管理规则

### 5.1 元数据访问

- **规则**: 统一元数据访问模式
- **标准**: 所有元数据访问必须通过集中式 API
- **实践**:
  - 实现元数据访问服务
  - 使用缓存优化性能
  - 提供类型安全的访问接口

### 5.2 数据状态管理

- **规则**: 清晰的数据流和状态管理
- **标准**: 应用应有明确的数据流向和状态变更机制
- **实践**:
  - 使用单向数据流
  - 集中管理共享状态
  - 明确状态拥有者

## 6. 测试和质量保障规则

### 6.1 测试覆盖率

- **规则**: 维持足够的测试覆盖率
- **标准**: 
  - 核心模块测试覆盖率 > 90%
  - 非核心模块测试覆盖率 > 70%
- **实践**:
  - 编写单元测试、集成测试和端到端测试
  - 使用测试驱动开发 (TDD)
  - 持续集成中包含覆盖率报告

### 6.2 代码审查

- **规则**: 所有代码变更必须经过审查
- **标准**: 审查应关注代码质量、结构和规则符合性
- **实践**:
  - 使用拉取请求工作流
  - 提供详细的变更描述
  - 使用自动化工具辅助审查

## 7. 文档规则

### 7.1 代码文档

- **规则**: 关键代码必须有文档说明
- **标准**: 接口、复杂函数和类必须有文档注释
- **实践**:
  - 使用 JSDoc/TSDoc 风格注释
  - 描述用途、参数和返回值
  - 包含使用示例

### 7.2 架构文档

- **规则**: 维护最新的架构文档
- **标准**: 文档应反映当前代码结构和设计决策
- **实践**:
  - 使用架构决策记录 (ADR)
  - 创建并更新架构图
  - 记录重要设计决策和理由

## 实施和监控

1. 将规则集成到 ESLint/TSLint 配置中
2. 在持续集成管道中添加规则检查
3. 建立定期代码健康检查流程
4. 基于实际项目情况持续更新和完善规则

---

*作者: 代码结构分析团队*  
*版本: 1.0*  
*日期: 2025-04-10* 